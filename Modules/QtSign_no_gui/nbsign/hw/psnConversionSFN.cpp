/****************************************************************************
** файл:        psnConversionSFN.cpp
** версия:
** дата:        01.03.2007
** изменен:
** автор:       Майоров А.В., Захаров О.С.
**
** описание:    Преобразование координат рукописных образов в функционалы.
**              Координаты X, Y, P, T и отсчёты времени преобразуются в
**              коэффициенты Фурье.
****************************************************************************/

#include "psnConversionSFN.h"
#include "BimHW.h"

#define  UNIVERSAL_DPI  1024      // разрешение промасштабированных образов, приведённых к 
                                  // одинаковому масштабу не зависимо от устройства ввода

/****************************************************************************
** ТАБЛИЦА МАТЕМАТИЧЕСКИХ ОЖИДАНИЙ, ПОЛУЧЕННАЯ НА ОБРАЗАХ С ДАВЛЕНИЕМ
** ..\Огромная подредактированная база\БАЗА просмотрел\bim
****************************************************************************/
static const float tableMo[psnFFT_COEF_COUNT] = {
  2.826980f,   -380.817871f, 4.874270f,  -7.951285f, 2.181546f,  -191.046249f, 3.825719f,  -2.010811f,
  0.879614f,   -125.806877f, 2.884359f,  -0.823466f, -0.026013f, -90.993362f,  1.759715f,  0.810726f,
  -0.782725f,  -69.620415f,  1.647877f,  1.231489f,  -0.952090f, -56.248169f,  2.011253f,  2.021281f,
  -0.428911f,  -48.859673f,  2.046185f,  2.449589f,  -0.617409f, -42.829639f,  1.345864f,  2.764799f,
  -0.928933f,  -37.913502f,  0.543808f,  2.731986f,  -1.378305f, -34.076733f,  -0.212807f, 2.540488f,
  -1.843811f,  -30.894020f,  -0.844061f, 2.342290f,  -2.107966f, -28.452602f,  -1.314324f, 1.687341f,
  -2.214549f,  -26.410561f,  -1.350794f, 1.222205f,  -2.259412f, -24.582611f,  -1.336802f, 0.899044f,
  -2.170824f,  -22.944475f,  -1.198035f, 0.740341f,  -2.157390f, -21.533747f,  -0.992228f, 0.637621f,
  -2.826913f,  380.817902f,  -4.874246f, 7.951284f,  2.181548f,  -191.046265f, 3.825719f,  -2.010813f,
  -0.879548f,  125.806923f,  -2.884338f, 0.823465f,  -0.026013f, -90.993370f,  1.759716f,  0.810726f,
  0.782793f,   69.620392f,   -1.647855f, -1.231490f, -0.952090f, -56.248188f,  2.011253f,  2.021282f,
  0.428979f,   48.859684f,   -2.046162f, -2.449589f, -0.617411f, -42.829639f,  1.345864f,  2.764799f,
  0.929001f,   37.913498f,   -0.543784f, -2.731984f, -1.378306f, -34.076733f,  -0.212807f, 2.540488f,
  1.843876f,   30.894016f,   0.844086f,  -2.342289f, -2.107966f, -28.452595f,  -1.314324f, 1.687343f,
  2.214618f,   26.410555f,   1.350818f,  -1.222204f, -2.259410f, -24.582611f,  -1.336802f, 0.899044f,
  2.170890f,   22.944477f,   1.198060f,  -0.740340f, -2.157390f, -21.533747f,  -0.992228f, 0.637621f,
  9.111629f,   -188.681534f, 8.802705f,  0.390103f,  8.695858f,  -88.263832f,  5.917253f,  3.415660f,
  2.691303f,   -54.622234f,  5.211985f,  3.996560f,  1.087511f,  -40.752544f,  3.145432f,  6.003526f,
  -0.425621f,  -31.752018f,  0.285328f,  5.703377f,  -1.788567f, -26.647160f,  -1.828904f, 3.840013f,
  -2.004827f,  -23.345133f,  -1.704808f, 2.006969f,  -1.951626f, -20.585012f,  -1.106341f, 1.076943f,
  -2.437436f,  -189.757050f, 0.181257f,  -5.220865f, -2.096991f, -94.870026f,  -0.204420f, -1.737326f,
  -2.047251f,  -63.697998f,  -0.131868f, -1.531723f, -2.435180f, -47.209141f,  -0.216103f, -1.014112f,
  -2.384814f,  -37.634182f,  -0.157460f, -0.771242f, -2.332284f, -31.426933f,  -0.212008f, -0.841557f,
  -2.280705f,  -26.927532f,  -0.087830f, -0.659717f, -2.347693f, -23.566961f,  -0.087184f, -0.588223f,
  -4.748584f,  -193.410751f, -1.151193f, -4.411729f, -8.747849f, -93.724091f,  -2.397797f, -1.794203f,
  -4.595499f,  -57.874283f,  -1.189467f, 0.045987f,  -2.322320f, -44.906960f,  -0.453697f, -0.473928f,
  -2.330989f,  -36.401043f,  -0.710943f, -0.622402f, -2.427378f, -30.258089f,  -0.799744f, -0.465306f,
  -2.513992f,  -25.819893f,  -0.968813f, -0.208892f, -2.363147f, -22.482380f,  -0.878135f, 0.198296f,
  -1.925519f,  571.853149f,  -7.832678f, 9.242510f,  2.044956f,  -87.118156f,  3.723905f,  3.358769f,
  3.951538f,   176.195145f,  -3.890602f, -2.510820f, 1.200350f,  -38.450031f,  2.907852f,  6.543736f,
  5.141587f,   105.787460f,  0.583128f,  -4.309707f, -1.883644f, -25.478586f,  -2.416635f, 4.216268f,
  6.799668f,   76.092804f,   2.761495f,  -1.138365f, -1.967103f, -19.500473f,  -1.897291f, 1.863452f,
  15.887092f,  -120.289581f, 11.001589f, 5.036059f,  5.356612f,  -50.081066f,  7.746576f,  6.638523f,
  1.716540f,   -32.091736f,  2.269350f,  9.546804f,  -1.486806f, -23.928265f,  -2.703698f, 6.094861f,
  -3.010462f,  -125.672539f, -0.175467f, -2.450169f, -3.605497f, -62.916817f,  0.449046f,  -1.468102f,
  -2.767702f,  -42.571114f,  0.325157f,  -0.672877f, -2.589282f, -31.983467f,  -0.102760f, -0.658838f,
  -2.672060f,  -125.700943f, 0.219178f,  -4.032496f, -2.588409f, -62.288837f,  -0.087070f, -1.374070f,
  -2.304264f,  -41.832123f,  -0.022665f, -1.001455f, -2.224162f, -31.443905f,  -0.078102f, -0.943206f,
  -1.985308f,  -125.333153f, -0.575074f, -2.225437f, -1.798248f, -62.036884f,  -0.132172f, -1.140655f,
  -1.901790f,  -42.309727f,  -0.065643f, -0.962969f, -1.930636f, -31.664862f,  0.066606f,  -0.807740f,
  -9.854074f,  -129.616318f, -1.953557f, -3.564414f, -6.014205f, -55.791256f,  -1.264560f, 0.641262f,
  -2.417823f,  -39.058395f,  -0.274397f, -0.451836f, -2.498423f, -29.544895f,  -0.677593f, -0.461354f,
  -25.278696f, 627.785583f,  -8.079050f, 6.511160f,  27.884176f, -41.031593f,  4.853920f,  9.520693f,
  -17.561495f, 196.800385f,  0.041718f,  -6.745750f, 23.561369f, -19.249630f,  -5.192386f, 5.108725f,
  19.684830f,  -81.425217f,  11.733813f, 8.311809f,  4.066377f,  -34.486496f,  6.354805f,  12.927334f,
  -5.265802f,  -96.763268f,  1.460539f,  -1.646187f, -2.037795f, -49.696690f,  0.484781f,  0.264452f,
  -2.293061f,  -95.102509f,  0.100682f,  -1.480474f, -1.891379f, -47.018501f,  -0.063918f, -0.920286f,
  -2.356964f,  -95.125633f,  0.155152f,  -3.407257f, -2.537471f, -47.006668f,  -0.095113f, -1.311175f,
  -1.900906f,  -94.637718f,  -0.509521f, -1.994152f, -2.979006f, -47.400517f,  -0.368290f, -1.107935f,
  1.169449f,   -96.516861f,  1.015966f,  -1.867382f, -1.466743f, -50.764194f,  0.345158f,  -1.695608f,
  -15.594727f, -92.811905f,  -4.286064f, -1.594243f, -1.665689f, -42.413708f,  -0.539109f, 0.160090f,
  6.557659f,   652.377930f,  -9.670595f, 3.677926f,  3.572373f,  -23.851463f,  4.648625f,  13.801426f
};

/****************************************************************************
** ТАБЛИЦА ДИСПЕРСИЙ ВСЕХ ЧУЖИХ, ПОЛУЧЕННАЯ НА ОБРАЗАХ С ДАВЛЕНИЕМ
** ..\Огромная подредактированная база\БАЗА просмотрел\bim
****************************************************************************/
static const float tableDisp[psnFFT_COEF_COUNT] = {
  59.608921f, 170.804047f, 31.615545f, 47.787155f, 30.524624f, 87.172104f, 29.443516f, 33.374622f,
  23.207184f, 60.297714f,  26.969940f, 30.836491f, 21.114336f, 46.942928f, 25.749720f, 28.555437f,
  20.471167f, 38.283569f,  24.713692f, 26.518253f, 19.521004f, 32.313282f, 23.658716f, 24.590416f,
  17.738321f, 28.678820f,  22.233339f, 23.246565f, 16.714701f, 26.157122f, 21.118818f, 22.196777f,
  15.789630f, 23.736256f,  19.825602f, 20.867249f, 14.831923f, 21.615471f, 18.571526f, 19.673126f,
  13.768326f, 19.604082f,  17.441326f, 17.912016f, 12.435716f, 18.020626f, 15.882973f, 16.370733f,
  10.979112f, 16.232735f,  13.481187f, 14.264766f, 9.498307f,  14.582553f, 11.769588f, 12.099347f,
  8.099607f,  13.120584f,  10.119958f, 10.265133f, 6.727308f,  11.817206f, 9.039216f,  8.415639f,
  59.608940f, 170.804062f, 31.615547f, 47.787163f, 30.524620f, 87.172081f, 29.443516f, 33.374630f,
  23.207186f, 60.297707f,  26.969948f, 30.836485f, 21.114336f, 46.942932f, 25.749725f, 28.555431f,
  20.471169f, 38.283569f,  24.713692f, 26.518246f, 19.521002f, 32.313278f, 23.658716f, 24.590412f,
  17.738327f, 28.678822f,  22.233345f, 23.246563f, 16.714703f, 26.157118f, 21.118818f, 22.196775f,
  15.789631f, 23.736258f,  19.825600f, 20.867249f, 14.831925f, 21.615473f, 18.571527f, 19.673130f,
  13.768332f, 19.604086f,  17.441326f, 17.912014f, 12.435719f, 18.020628f, 15.882974f, 16.370733f,
  10.979115f, 16.232733f,  13.481185f, 14.264765f, 9.498308f,  14.582552f, 11.769590f, 12.099344f,
  8.099611f,  13.120587f,  10.119958f, 10.265132f, 6.727308f,  11.817206f, 9.039217f,  8.415638f,
  46.262321f, 103.254730f, 41.457741f, 47.960678f, 30.540350f, 57.649044f, 37.596622f, 41.786964f,
  27.786922f, 41.023922f,  35.649654f, 36.037003f, 23.761087f, 33.846230f, 31.570072f, 33.217209f,
  20.823109f, 27.677876f,  27.443079f, 29.203327f, 17.263117f, 23.032269f, 22.426060f, 24.055393f,
  13.095536f, 18.412981f,  16.703182f, 17.982389f, 9.306586f,  14.804907f, 12.727253f, 12.976267f,
  38.893490f, 96.355316f,  38.888290f, 43.978794f, 29.996941f, 53.103432f, 35.768707f, 38.220757f,
  27.319336f, 40.536812f,  32.332458f, 34.159821f, 23.608727f, 32.800041f, 29.100008f, 30.793619f,
  20.991823f, 27.704124f,  25.742237f, 27.170696f, 17.647652f, 23.458584f, 21.513693f, 22.873724f,
  13.445824f, 18.933901f,  16.744680f, 17.667049f, 9.474060f,  14.871869f, 12.951354f, 12.562673f,
  42.014130f, 97.852409f,  40.239185f, 41.986816f, 29.327263f, 54.612583f, 34.484108f, 37.150772f,
  26.340614f, 39.499825f,  29.849245f, 33.282104f, 22.985508f, 32.378456f, 27.228338f, 29.355921f,
  20.422489f, 27.703932f,  24.282871f, 26.108770f, 17.313833f, 23.242649f, 21.235640f, 22.560724f,
  13.502791f, 18.953970f,  15.940702f, 17.343084f, 9.801353f,  15.061672f, 11.543058f, 13.155085f,
  51.621307f, 251.910645f, 40.171452f, 68.870415f, 28.337658f, 57.454819f, 34.048214f, 41.869690f,
  25.936920f, 83.146561f,  33.154564f, 39.720409f, 22.561172f, 32.903767f, 29.209188f, 32.424984f,
  20.011274f, 51.874363f,  25.372316f, 30.162714f, 16.571566f, 22.562872f, 22.185852f, 23.784182f,
  13.398905f, 36.572269f,  15.988397f, 19.754644f, 9.787095f,  15.146562f, 19.329275f, 13.832395f,
  43.326248f, 85.373039f,  49.691765f, 53.732716f, 33.447701f, 47.587250f, 45.111088f, 45.157021f,
  26.863575f, 36.044800f,  36.629097f, 38.976818f, 20.432142f, 26.980034f, 27.136171f, 30.076893f,
  40.306805f, 73.938271f,  47.708809f, 52.568905f, 34.055965f, 47.226994f, 40.728199f, 44.473534f,
  27.528313f, 35.955212f,  34.755165f, 37.794453f, 21.449125f, 28.049431f, 27.001926f, 29.817854f,
  39.230450f, 73.315239f,  44.834328f, 49.165672f, 32.934723f, 46.009823f, 39.574516f, 42.359936f,
  27.095938f, 35.015125f,  33.579750f, 35.852211f, 21.255642f, 27.404879f, 26.898993f, 28.279066f,
  37.985992f, 71.898285f,  42.244080f, 47.904053f, 32.037476f, 44.772472f, 37.388767f, 39.715359f,
  26.531061f, 34.275261f,  31.784796f, 33.744629f, 21.044018f, 27.193390f, 25.998724f, 27.277153f,
  41.475479f, 76.450882f,  42.517960f, 49.825588f, 31.308275f, 45.963791f, 34.832970f, 40.066746f,
  26.129681f, 34.896652f,  30.557186f, 33.686214f, 20.656948f, 27.115252f, 25.038635f, 26.874950f,
  46.463291f, 278.094635f, 43.554955f, 77.146240f, 32.559994f, 46.098553f, 39.699261f, 44.396637f,
  25.893105f, 91.603958f,  32.986088f, 43.719749f, 22.482073f, 25.898741f, 25.857134f, 29.792494f,
  41.616070f, 77.295586f,  51.818909f, 63.115753f, 32.420891f, 45.653988f, 46.271877f, 49.383522f,
  43.543232f, 67.829857f,  53.620808f, 61.334915f, 34.058689f, 45.114075f, 42.595558f, 47.077812f,
  42.351677f, 65.227600f,  49.647438f, 54.750862f, 33.170071f, 43.160297f, 41.264439f, 45.199528f,
  41.817204f, 64.931175f,  49.034836f, 53.984718f, 32.761341f, 42.740700f, 40.576000f, 44.408688f,
  40.344166f, 63.204044f,  47.424294f, 52.259563f, 32.363380f, 41.970261f, 39.087330f, 42.364506f,
  38.782951f, 62.824318f,  44.575111f, 48.046577f, 31.482660f, 41.546417f, 36.038620f, 38.757370f,
  40.753281f, 70.664024f,  46.005688f, 53.817642f, 31.476694f, 42.679146f, 36.157085f, 41.821228f,
  42.641438f, 290.809235f, 45.724438f, 84.362823f, 28.921448f, 42.247669f, 39.517086f, 47.184624f
};

/****************************************************************************
** ТАБЛИЦА МАТЕМАТИЧЕСКИХ ОЖИДАНИЙ КОЭФФИЦИЕНТОВ ДАВЛЕНИЯ,
** ПОЛУЧЕННАЯ НА СЖАТОЙ БАЗЕ ОБРАЗОВ
****************************************************************************/
static const float tableMoP[psnP_COEF_COUNT] = {
  -1.6355704f,  -6.6228499f,  -2.3774314f,  -4.5957375f,  -2.2547276f,  -4.9515738f,  -0.1023198f,  -3.3977566f,
  -2.2168479f,  -3.3744624f,  -1.7153455f,  -4.7570577f,  -2.0700347f,  -3.5645924f,  -0.7937717f,  -3.6762862f,
  -1.6975414f,  -4.1207042f,  -1.1390420f,  -2.0956044f,  -0.9261177f,  -2.6844561f,  -1.0953180f,  -2.4651444f,
  -0.9719559f,  -2.5287728f,  -1.3417840f,  -1.4701059f,  -1.5951517f,  -1.4990828f,  -0.8377821f,  -1.3711838f,
  1.6355799f,   6.6228428f,   -2.3774312f,  -4.5957389f,  2.2547386f,   4.9515710f,   -0.1023208f,  -3.3977556f,
  2.2168572f,   3.3744605f,   -1.7153447f,  -4.7570577f,  2.0700450f,   3.5645936f,   -0.7937717f,  -3.6762877f,
  1.6975516f,   4.1207042f,   -1.1390417f,  -2.0956049f,  0.92612755f,  2.6844566f,   -1.0953177f,  -2.4651444f,
  0.97196627f,  2.5287724f,   -1.3417840f,  -1.4701059f,  1.5951614f,   1.4990835f,   -0.8377821f,  -1.3711839f
};

/****************************************************************************
** ТАБЛИЦА ДИСПЕРСИЙ КОЭФФИЦИЕНТОВ ДАВЛЕНИЯ,
** ПОЛУЧЕННАЯ НА СЖАТОЙ БАЗЕ ОБРАЗОВ
****************************************************************************/
static const float tableDispP[psnP_COEF_COUNT] = {
  15.065f, 18.736f, 13.197f, 15.534f, 9.123f,  12.498f, 8.596f,  11.372f,
  10.097f, 9.548f,  6.232f,  9.033f,  6.710f,  6.475f,  6.779f,  7.040f,
  5.045f,  7.364f,  4.866f,  6.353f,  4.880f,  5.002f,  3.322f,  4.917f,
  4.060f,  4.282f,  2.734f,  3.137f,  3.542f,  3.211f,  2.095f,  3.313f,
  15.065f, 18.736f, 13.197f, 15.534f, 9.123f,  12.498f, 8.596f,  11.372f,
  10.097f, 9.548f,  6.232f,  9.033f,  6.710f,  6.475f,  6.779f,  7.040f,
  5.045f,  7.364f,  4.866f,  6.353f,  4.880f,  5.002f,  3.322f,  4.917f,
  4.060f,  4.282f,  2.734f,  3.137f,  3.542f,  3.211f,  2.095f,  3.313f
};

//////////////////////////////////////////////////////////////////////////
//назначение: вычисление коэффициентов Фурье для рукописного образа
//параметры:
// img		- [вх]  исходный биообраз
// coeffs	- [вых] массив вычисленных коэффициентов Фурье
//
void NcCalcCoefFromBim( const BimHw &bim, Vbp &coeffs ) {
  // Координаты одного образа
  nbBimHwHeader *img    = bim.header();
  nbPointHw     *points = (nbPointHw*)bim.data();

  // Промасштабировать координаты образа до 512 точек
  nbPointHw pointsS[psnHW_SCALE_COUNT];  // промасштабированный образ 
  scaleHwTo512(points, img->num, pointsS);
  // Привести к новому масштабу dpi
  scaleHwByDpi(pointsS, psnHW_SCALE_COUNT, img->dpiX, UNIVERSAL_DPI, img->dpiY, UNIVERSAL_DPI);
  // Сдвинуть начало образа в нулевую точку
  shiftHwToOrigin(pointsS, psnHW_SCALE_COUNT);
  // Вычислить коэффициенты Фурье
  fftHw512ToW416R32(pointsS, coeffs);
  // Нормализовать полученные коэффициенты
  float *aver = (float*)tableMo;
  float *disp = (float*)tableDisp;
  normR32(coeffs, (Vbp&)aver, (Vbp&)disp, psnFFT_COEF_COUNT);

  // Добавить давление
  // Вычислить коэффициенты Фурье давления
  fftHw512PToW64R32(pointsS, coeffs, psnFFT_COEF_COUNT);
  // Нормализовать полученные коэффициенты
  aver = (float*)tableMoP;
  disp = (float*)tableDispP;
  normR32(coeffs, (Vbp&)aver, (Vbp&)disp, psnP_COEF_COUNT, psnFFT_COEF_COUNT);

  memset(pointsS,0,sizeof(pointsS));
}

//////////////////////////////////////////////////////////////////////////
//назначение: вычисление коэффициентов Фурье группы биометрических образов
//описание: координаты всех биометрических образов преобразуются в коэффициенты
//          Фурье и записываются в вектор биометрических параметров
//параметры: 
//  bim   - [вх]  входные биометрические образы
//	vbps  - [вых] полученный вектор биометрических параметров
//
nbResult NcCalcImagesCoef ( const nbBim **bim, NbMatrix &vbps ) {
  BimHw hwbim;
  // Вычислить коэффициенты Фурье i-го образа
  for ( uint32_t i = 0; i < vbps.ncols(); i++ ) {
    hwbim.fromBim(bim[i]);
    NcCalcCoefFromBim ( hwbim, vbps.at(0,i) );
  }
  return nbS_OK;
}
